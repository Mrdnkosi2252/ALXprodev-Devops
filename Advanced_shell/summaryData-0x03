#!/bin/bash

INPUT_DIR="pokemon_data"
OUTPUT_CSV="pokemon_report.csv"
TEMP_FILE="temp_pokemon_data.txt"
SORTED_FILE="sorted_pokemon_data.txt"

# Validate input directory and JSON files
if [ ! -d "$INPUT_DIR" ] || [ -z "$(ls -A $INPUT_DIR/*.json 2>/dev/null)" ]; then
    echo "Error: No JSON files found in $INPUT_DIR"
    exit 1
fi

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$OUTPUT_CSV"

# Extract data
> "$TEMP_FILE"
for file in "$INPUT_DIR"/*.json; do
    if [ -s "$file" ]; then
        jq -r '[.name, (.height/10), (.weight/10)] | @csv' "$file" >> "$TEMP_FILE"
    fi
done

# Sort by weight descending (-r for numeric reverse), then append to CSV
sort -t, -k3 -nr "$TEMP_FILE" > "$SORTED_FILE"
cat "$SORTED_FILE" >> "$OUTPUT_CSV"

# Append average stats to the CSV
awk -F, '
NR > 1 {
    height += $2
    weight += $3
    count++
}
END {
    if (count > 0) {
        printf "\nAverage Height: %.2f m\nAverage Weight: %.2f kg\n", height/count, weight/count
    } else {
        print "\nNo data to calculate averages."
    }
}' "$SORTED_FILE" >> "$OUTPUT_CSV"
